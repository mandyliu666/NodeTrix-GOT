<!DOCTYPE html>
<html>
<head>
	<title>A Song of Ice and Fire</title>
	<meta charset="utf-8">
	<style>
      @import url('https://fonts.googleapis.com/css?family=Martel+Sans:200,400,700,800,900');
    </style>
	<script src="lib/d3/d3.js" charset="utf-8"></script>
	<script src="lib/d3/d3.min.js" charset="utf-8"></script>
	<script src="lib/d3-lasso.min.js" charset="utf-8"></script>
	<script src="lib/keymaster.js" charset="utf-8"></script>
	<script src="src/lasso.js" charset="utf-8"></script>
	<script src="src/zoom.js" charset="utf-8"></script>
	<script src='src/matrix.js' charset='utf-8'></script>
	<script src='src/graph.js' charset='utf-8'></script>
	<script src="src/path.js" charset="utf-8"></script>
	<script src="lib/d3-tip.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
	<header>
		
	</header>
	<div id="title">A Song of Ice and Fire</div>
	<div id="background">
		<div id="controlPanel">
			<div id="bookSelector"></div>
			<div id="nodeSlider">
				<input type="range" min="1" max="100" value="50" class="slider" id="myRange">
			</div>
			<div id="colorLegend">
				<input id="checkStark" type="checkbox">
				<input id="checkArryn" type="checkbox">
				<input id="checkLannister" type="checkbox">
				<input id="checkGreyjoy" type="checkbox">
				<input id="checkMartell" type="checkbox">
				<input id="checkBaratheon" type="checkbox">
				<input id="checkTargaryen" type="checkbox">
				<input id="checkTyrell" type="checkbox">
			</div>
		</div>
		<div id="networkPlot"></div>
		<script>
		var margin = {top: 0, right: 0, bottom: 0, left: 0},
		width = 900 - margin.left - margin.right,
		height = 600 - margin.top - margin.bottom;
		var colorlegend = {
			"Stark": "#635e51",
			//"Tully": "",
			"Arryn": "#3d4e99",
			"Lannister": "#ebda58",
			"Greyjoy": "#3b394d",
			"Martell": "#c45302",
			"Baratheon": "#8c4054",
			"Targaryen": "#960702",
			//"Frey": "",
			"Tyrell": "#4e7524"
		};
		var graph = new Graph(width, height, colorlegend);
		function visualize(booknumber) {
			d3.selectAll("#networkPlot > *").remove();
			d3.csv(('data/asoiaf-book' + booknumber + '-edges.csv'), function(error, dataLink) {
				dataLink.forEach(function(d) {
					d.Target = split(d.Target);
					d.Source = split(d.Source);
				});
				d3.csv(("data/asoiaf-book" + booknumber + "-nodes.csv"), function(errNode, dataNode) {
					dataNode.forEach(function(d) {
						d.Id = split(d.Id);
					});
					var svg = d3.select('#networkPlot')
						.append('svg')
						.attr('id', 'mainsvg')
						.attr('width', width)
						.attr('height', height);

					// remove previous graphs
					d3.selectAll("#matrix > *").remove();
					d3.selectAll("#force > *").remove();
					d3.selectAll("#path > *").remove();

					var matrix_layer = svg.append('g').attr('id', 'matrix');
					var force_layer = svg.append('g').attr('id', 'force');
					var path_layer = svg.append('g').attr('id', 'path');
					//initialize
					graph = new Graph(width, height, colorlegend);
					paths = new Paths();
					matrix_list = [];
					matrix_nodes = [];

					var transform = {
						x: 0.0,
						y: 0.0,
						k: 1.0
					};
					var threshold = 2;
					var dataLinks = [];
					var dataNodes = [];
					var nodeWeight = {};
					var neighbors = {};
					
					//var paths = new Paths();
					var m = new Matrix(0);
					m.Create(['Aemon-Targaryen-', 'Jon-Snow', 'Eddard-Stark','Aggo'], dataLink);
					matrix_list.push(m);
					
					for (var i in matrix_list) 
						for (var j in matrix_list[i].nodes) 
							matrix_nodes.push(matrix_list[i].nodes[j]);
					dataNode.forEach(function(d) {
						d.id = d.Id;
						d.label = d.Label;
						d.fam = d.Family;
						nodeWeight[d.id] = 0;
						neighbors[d.id] = [];
						if (matrix_nodes.indexOf(d.Id) < 0) {
							dataNodes.push(d);
						}
					});
					dataLink.forEach(function(d) {
						d.weight = +d.weight;
						d.source = d.Source;
						d.target = d.Target;
						nodeWeight[d.source]++;
						nodeWeight[d.target]++;
						neighbors[d.source].push(d.target);
						neighbors[d.target].push(d.source);
						if(matrix_nodes.indexOf(d.source)<0 && matrix_nodes.indexOf(d.target)<0) { 
							dataLinks.push(d);
						}
					});
					dataNodes = dataNodes.filter(function(d) {
						return nodeWeight[d.id] >= 3;
					});
					dataLinks = dataLinks.filter(function(d) {
						return nodeWeight[d.source] >= 3 && nodeWeight[d.target] >= 3;
					});
					
					for (var i in matrix_list) matrix_list[i].Render();
					//draw_force(width, height, dataLinks, dataNodes, transform, svg, force_layer);
					
					//var graph = new Graph();
					graph.create(dataLinks, dataNodes, neighbors, nodeWeight, transform);
					
					var l = new Lasso();
					l.bind();
					
					var z = new Zoom(svg, transform);
					
					paths.Create(dataNode, dataLink);
					paths.Render();			
				
					
					// var slider = document.getElementById("myRange");
					// var output = document.getElementById("demo");
					// output.innerHTML = slider.value; // Display the default slider value
					// // Update the current slider value (each time you drag the slider handle)
					// slider.oninput = function() {
					//     output.innerHTML = this.value;
					// }
				//suggest I have a list of m
				});
			});

		}
		var split = function(str) {
			if (str.indexOf('(') >= 0) str = str.slice(0, str.indexOf('('));
			return str;
		}

		visualize(1);

		var options = [
			{ "value": 1, "text": "I: A Game of Thrones" },
			{ "value": 2, "text": "II: A Clash of Kings" },
			{ "value": 3, "text": "III: A Storm of Swords" },
			{ "value": 4, "text": "IV: A Feast for Crows" },
			{ "value": 5, "text": "V: A Dance with Dragons" }
		];

		var dropdown = d3.select("#bookSelector");

		dropdown
			.append("select")
			.selectAll("option")
	        .data(options)
	        .enter()
	        .append("option")
	        .attr("value", function(d){
	            return d["value"];
	        })
	        .text(function(d){
	            return d["text"];
	        });

	    dropdown
	    	.on("change", function() {
	    		var num = d3.event.target.value;
	    		visualize(num);
	    	});
		</script>
	</div>
	
	<h1>Copyright &copy; 2018 Jiayu Tang & Yingdi Liu<h1>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
	<title>A Song of Ice and Fire</title>
	<meta charset="utf-8">
	<style>
      @import url('https://fonts.googleapis.com/css?family=Martel+Sans:200,400,700,800,900');
    </style>
	<script src="lib/d3/d3.js" charset="utf-8"></script>
	<script src="lib/d3/d3.min.js" charset="utf-8"></script>
	<script src="lib/d3-lasso.min.js" charset="utf-8"></script>
	<script src="lib/keymaster.js" charset="utf-8"></script>
	<script src="src/lasso.js" charset="utf-8"></script>
	<script src="src/zoom.js" charset="utf-8"></script>
	<script src='src/matrix.js' charset='utf-8'></script>
	<script src='src/graph.js' charset='utf-8'></script>
<!-- 	<script src='src/force.js' charset='utf-8'></script> -->
	<script src="src/path.js" charset="utf-8"></script>
	<script src="lib/d3-tip.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
	<header>
		
	</header>
	<div id="title">A Song of Ice and Fire</div>
	<div id="background">
		<div id="controlPanel">
			<div id="bookSelector"></div>
			<div id="nodeSlider">
				<input type="range" min="1" max="100" value="50" class="slider" id="myRange">
			</div>
		</div>
		<div id="networkPlot"></div>
		<script>
		var margin = {top: 0, right: 0, bottom: 0, left: 0},
		width = 900 - margin.left - margin.right,
		height = 600 - margin.top - margin.bottom;
		var svg = d3.select('#networkPlot')
					.append('svg')
					.attr('id', 'mainsvg')
					.attr('width', width)
					.attr('height', height);
		//console.log(d3.select('#mainsvg'));
		var matrix_layer = svg.append('g').attr('id', 'matrix');
		var force_layer = svg.append('g').attr('id', 'force');
		var path_layer = svg.append('g').attr('id', 'path');
		d3.csv('data/asoiaf-book1-edges.csv', function(error, dataLink) {
			dataLink.forEach(function(d) {
				d.Target = split(d.Target);
				d.Source = split(d.Source);
			});
			d3.csv("data/asoiaf-book1-nodes.csv", function(errNode, dataNode) {
				dataNode.forEach(function(d) {
					d.Id = split(d.Id);
				});
				//console.log
				var matrix_list = [];
				var transform = {
					x: 0.0,
					y: 0.0,
					k: 1.0
				};
				var threshold = 2;
				var dataLinks = [];
				var dataNodes = [];
				var nodeWeight = {};
				var neighbors = {};
				var m = new Matrix(0);
				m.create(['Aemon-Targaryen-', 'Jon-Snow', 'Eddard-Stark','Aggo'], dataLink);
				matrix_list.push(m);

				dataNode.forEach(function(d) {
					d.id = d.Id;
					d.label = d.Label;
					nodeWeight[d.id] = 0;
					neighbors[d.id] = [];
					if (m.nodes.indexOf(d.Id) < 0) {
						dataNodes.push(d);
					}
				});

				dataLink.forEach(function(d) {
					d.weight = +d.weight;
					d.source = d.Source;
					d.target = d.Target;
					nodeWeight[d.source]++;
					nodeWeight[d.target]++;
					neighbors[d.source].push(d.target);
					neighbors[d.target].push(d.source);
					if(m.nodes.indexOf(d.source)<0 && m.nodes.indexOf(d.target)<0) { 
						dataLinks.push(d);
					}
				});

				dataNodes = dataNodes.filter(function(d) {
					return nodeWeight[d.id] >= 3;
				});

				dataLinks = dataLinks.filter(function(d) {
					return nodeWeight[d.source] >= 3 && nodeWeight[d.target] >= 3;
				});
				
				for (var i in matrix_list) matrix_list[i].render();
				//draw_force(width, height, dataLinks, dataNodes, transform, svg, force_layer);
				var graph = new Graph();
				graph.create(width, height, dataLinks, dataNodes, neighbors, nodeWeight, transform);


				var l = new Lasso();
				l.bind();
				var z = new Zoom(svg, force_layer, transform);
				//z.unbind();

				

				//var l = new Lasso();
				//l.bind();

				// var elementz = z;
				// var elementl = l;
				// d3.select('body')
				// 	.on("keydown", function() {
				// 		if(d3.event.shiftKey) {
				// 			elementz.unbind();
				// 			elementl.bind();
				// 		}
				// 	})
				// 	.on("keyup", function() {
				// 		var newz = new Zoom(svg, force_layer, transform);
				// 		newz.bind();
				// 		elementz = newz;
				// 		var newl = new Lasso();
				// 		elementl = newl;
				// 	});
			



				var paths = new Paths();
				paths.Create(m.nodes, matrix_list, dataNode, dataLink);
				paths.Render();

				// var slider = document.getElementById("myRange");
				// var output = document.getElementById("demo");
				// output.innerHTML = slider.value; // Display the default slider value

				// // Update the current slider value (each time you drag the slider handle)
				// slider.oninput = function() {
				//     output.innerHTML = this.value;
				// }
			
			//suggest I have a list of m
			});
		});
		var split = function(str) {
			if (str.indexOf('(') >= 0) str = str.slice(0, str.indexOf('('));
			return str;
		}
		</script>
	</div>
	
	<h1>Copyright &copy; 2018 Jiayu Tang & Yingdi Liu<h1>
</body>
</html>